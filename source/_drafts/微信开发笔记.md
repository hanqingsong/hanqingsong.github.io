---
title: 微信开发笔记
date: 2018-05-29 11:44:50
categories:
tags:
---
## 服务号和订阅号
首先是两者在微信中出现的位置不同，订阅号出现在专门的订阅号单独二级入口里，而公众号则出现在微信主页上；相对的，两者触达用户的能力也是有很大差别的，服务号每个月只能给用户群发4次消息，而订阅号每天都可以向用户推送一条消息，由此可见，微信将订阅号放在单独的二级入口里也是很有必要的，否则谁受得了每天那么多条新消息出现在自己的微信首页上；两者的接口权限也有很大的区别，具体可见官方文档，简而言之，如果是要做微信开发，要获取到微信用户信息，那基本上必须要用服务号来做，如果要接微信支付，则还需要将服务号认证。

作者：SawyerZhou
链接：https://www.jianshu.com/p/8e536f022438
來源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

## access_token
主动调用微信的相关接口，需要使用到Access_token。
access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。

公众号可以使用AppID和AppSecret调用本接口来获取access_token。AppID和AppSecret可在“微信公众平台-开发-基本配置”页中获得

## 公众号内网页
许多复杂的业务场景，需要通过网页形式来提供服务，这时需要用到：
1）网页授权获取用户基本信息：通过该接口，可以获取用户的基本信息（获取用户的OpenID是无需用户同意的，获取用户的基本信息则需用户同意）
2）微信JS-SDK：是开发者在网页上通过JavaScript代码使用微信原生功能的工具包，开发者可以使用它在网页上录制和播放微信语音、监听微信分享、上传手机本地图片、拍照等许多能力。

## 微信网页授权
文档 https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842
通过微信认证打开页面，并校验用户是否绑定已有账号
如果用户在微信客户端中访问第三方网页，公众号可以通过微信网页授权机制，来获取用户基本信息，进而实现业务逻辑。因此，可以通过微信网页的授权机制，在用户访问公众号后台网页时获取访问用户的相关信息。

```
微信的认证授权是基于OAuth2.0机制实现的，有关OAuth2.0的知识可参考网上的资料。OAuth2.0基本模式可以理解为用户在授权方进行登录，再由授权方回调请求授权方的接口并带上接口调用凭证，请求授权方再使用该凭证和秘钥信息调用授权方用户信息的相关接口
```

微信授权的基本步骤如下：
1. 用户同意授权，获取code
2. 通过code换取网页授权access_token和openid
3. 刷新access_token（如果需要）
4. 拉取用户信息(需scope为 snsapi_userinfo)(如果需要获取微信用户信息)
5. 检验授权凭证（access_token）是否有效

## 网页授权的两种scope的区别
1、以snsapi_base为scope发起的网页授权，是用来获取进入页面的用户的openid的，并且是静默授权并自动跳转到回调页的。用户感知的就是直接进入了回调页（往往是业务页面）
2、以snsapi_userinfo为scope发起的网页授权，是用来获取用户的基本信息的。但这种授权需要用户手动同意，并且由于用户同意过，所以无须关注，就可在授权后获取该用户的基本信息。
3、用户管理类接口中的“获取用户基本信息接口”，是在用户和公众号产生消息交互或关注后事件推送后，才能根据用户OpenID来获取用户基本信息。这个接口，包括其他微信接口，都是需要该用户（即openid）关注了公众号后，才能调用成功的。

## 网页授权access_token和普通access_token的区别
1、微信网页授权是通过OAuth2.0机制实现的，在用户授权给公众号后，公众号可以获取到一个网页授权特有的接口调用凭证（网页授权access_token），通过网页授权access_token可以进行授权后接口调用，如获取用户基本信息；
2、其他微信接口，需要通过基础支持中的“获取access_token”接口来获取到的普通access_token调用。
通过普通access_token获取用户信息时，如果用户未关注，信息获取就为空。而网页授权access_token的获取，只要用户许可，就可以获得，不论用户是否关注。

## UnionID机制
1、请注意，网页授权获取用户基本信息也遵循UnionID机制。即如果开发者有在多个公众号，或在公众号、移动应用之间统一用户帐号的需求，需要前往微信开放平台（open.weixin.qq.com）绑定公众号后，才可利用UnionID机制来满足上述需求。
2、UnionID机制的作用说明：如果开发者拥有多个移动应用、网站应用和公众帐号，可通过获取用户基本信息中的unionid来区分用户的唯一性，因为同一用户，对同一个微信开放平台下的不同应用（移动应用、网站应用和公众帐号），unionid是相同的。

## 特殊场景下的静默授权
1、 以snsapi_base为scope的网页授权，就静默授权的，用户无感知
2、对于已关注公众号的用户，如果用户从公众号的会话或者自定义菜单进入本公众号的网页授权页，即使是scope为snsapi_userinfo，也是静默授权，用户无感知

网页授权流程分为四步：
1、引导用户进入授权页面同意授权，获取code
2、通过code换取网页授权access_token（与基础支持中的access_token不同）
3、如果需要，开发者可以刷新网页授权access_token，避免过期
4、通过网页授权access_token和openid获取用户基本信息（支持UnionID机制）

## 微信退款
如果未结算金额不足，会退款失败，这个时候需要代码中设定使用余额支付

## 微信支付HTTPS服务器证书验证指引
https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=23_4

## 资料
微信公众平台 https://mp.weixin.qq.com/
https://www.jianshu.com/p/821db2e80207
https://www.jianshu.com/p/8e536f022438?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation
